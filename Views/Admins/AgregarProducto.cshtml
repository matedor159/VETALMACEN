@model SisAlmacenProductos.Models.Producto

@{
    ViewBag.Title = "Agregar Producto";
    // ViewBag.SubCategorias debe contener List<SubCategoria> (inyectado desde controller)
    var subcats = ViewBag.SubCategorias as List<SisAlmacenProductos.Models.SubCategoria> ?? new List<SisAlmacenProductos.Models.SubCategoria>();
}

<h2>Agregar Producto</h2>

@Html.ValidationSummary(true, "", new { @class = "text-danger" })

<form asp-action="AgregarProducto" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label asp-for="Codigo" class="form-label"></label>
        @Html.TextBoxFor(m => m.Codigo, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Codigo, "", new { @class = "text-danger" })
    </div>

    <div class="mb-3">
        <label asp-for="Nombre" class="form-label"></label>
        @Html.TextBoxFor(m => m.Nombre, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Nombre, "", new { @class = "text-danger" })
    </div>

    <div class="mb-3">
        <label asp-for="Descripcion" class="form-label"></label>
        @Html.TextAreaFor(m => m.Descripcion, new { @class = "form-control", rows = "3" })
        @Html.ValidationMessageFor(m => m.Descripcion, "", new { @class = "text-danger" })
    </div>

    <div class="mb-3">
        <label asp-for="Marca" class="form-label"></label>
        @Html.TextBoxFor(m => m.Marca, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Marca, "", new { @class = "text-danger" })
    </div>

    <div class="form-group">
        <label class="form-label">Categoría</label>
        @Html.TextBoxFor(m => m.Categoria, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Categoria, "", new { @class = "text-danger" })
    </div>

    <div class="mb-3">
        <label asp-for="Precio" class="form-label"></label>
        @Html.TextBoxFor(m => m.Precio, new { @class = "form-control", type = "number", step = "0.01" })
        @Html.ValidationMessageFor(m => m.Precio, "", new { @class = "text-danger" })
    </div>

    <div class="mb-3">
        <label asp-for="Stock" class="form-label"></label>
        @Html.TextBoxFor(m => m.Stock, new { @class = "form-control", type = "number", min = "0" })
        @Html.ValidationMessageFor(m => m.Stock, "", new { @class = "text-danger" })
    </div>

    <div class="mb-3">
        <label class="form-label">Subir imagen</label>
        <input type="file" id="inputImagen" name="Imagen" accept="image/*" class="form-control" />
        <small class="form-text text-muted">Formatos permitidos: JPG, PNG, WebP. Máx. 5 MB.</small>
    </div>

    <div class="mb-3">
        <label class="form-label">O pegar URL (opcional)</label>
        @Html.TextBoxFor(m => m.ImagenUrl, new { @class = "form-control", placeholder = "https://..." })
        @Html.ValidationMessageFor(m => m.ImagenUrl, "", new { @class = "text-danger" })
    </div>

    <div class="mb-3">
        <label class="form-label">Vista previa</label>
        <div>
            <img id="preview" src="@(Model?.ImagenUrl ?? "")" alt="Preview" style="max-width:200px; max-height:200px; display:@(string.IsNullOrEmpty(Model?.ImagenUrl) ? "none" : "block"); object-fit:cover; border:1px solid #ddd; padding:4px;" />
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <a asp-action="Productos" class="btn btn-secondary ms-2">Cancelar</a>
</form>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        (function () {
            const input = document.getElementById('inputImagen');
            const preview = document.getElementById('preview');

            input.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) {
                    // Si no hay archivo, no cambiar la vista previa
                    if (!preview.src) preview.style.display = 'none';
                    return;
                }

                // Validar tamaño (5 MB)
                const maxBytes = 5 * 1024 * 1024;
                if (file.size > maxBytes) {
                    alert('La imagen excede el tamaño máximo (5 MB).');
                    input.value = '';
                    preview.style.display = 'none';
                    return;
                }

                // Mostrar preview local
                const url = URL.createObjectURL(file);
                preview.src = url;
                preview.style.display = 'block';
            });

            // Si el usuario pega una URL manualmente, actualizar preview
            const urlInput = document.querySelector('input[name="ImagenUrl"]');
            if (urlInput) {
                urlInput.addEventListener('input', function () {
                    const val = urlInput.value.trim();
                    if (val) {
                        preview.src = val;
                        preview.style.display = 'block';
                    } else {
                        // Si no hay URL y no hay archivo, ocultar
                        if (!input.files.length) {
                            preview.src = '';
                            preview.style.display = 'none';
                        }
                    }
                });
            }
        })();
    </script>
}
